<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR-JMT Audio</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #D32F2F;
            --primary-hover-color: #B71C1C;
            --card-bg-color: rgba(255, 255, 255, 0.85);
            --text-primary-color: #212529;
            --text-secondary-color: #6c757d;
            --border-radius-main: 24px;
            --border-radius-inner: 18px;
            --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            --shadow-strong: 0 12px 40px 0 rgba(0, 0, 0, 0.15);
        }
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-image: url('https://img2.pic.in.th/pic/Cover808900978ea91797.jpg'); 
            background-size: cover; background-position: center; background-repeat: no-repeat; 
            background-attachment: fixed; display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; padding: 1rem; margin: 0;
        }
        .app-container {
            width: 100%; max-width: 1400px; height: 96vh; background: var(--card-bg-color);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius-main); box-shadow: var(--shadow-strong);
            border: 1px solid rgba(255, 255, 255, 0.2); display: flex; flex-direction: column; overflow: hidden;
        }
        .login-card {
            background: var(--card-bg-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius-main); box-shadow: var(--shadow-strong);
            border: 1px solid rgba(255, 255, 255, 0.2); max-width: 450px; width: 100%; padding: 2.5rem;
        }
        .player-header {
            padding: 1.5rem 2.5rem 1rem 2.5rem; flex-shrink: 0; border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        #audio-list-container {
            flex-grow: 1; overflow-y: auto; padding: 1.5rem 2.5rem; position: relative;
        }
        #audio-list-container::-webkit-scrollbar { width: 8px; }
        #audio-list-container::-webkit-scrollbar-track { background: transparent; }
        #audio-list-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        #audio-list-container::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .card-title { font-weight: 700; color: var(--text-primary-color); font-size: 1.8rem; margin-bottom: 0.25rem; }
        .card-subtitle { color: var(--text-secondary-color); margin-bottom: 1.5rem; font-size: 1rem; }
        .form-control, #employeeIdInput { font-size: 1.1rem; padding: 12px 20px; height: auto; border-radius: 12px; border: 1px solid #ddd; background-color: #fff; }
        #loginButton { font-size: 1.1rem; font-weight: 500; padding: 12px; background-color: var(--primary-color); border-color: var(--primary-color); border-radius: 12px; transition: background-color 0.2s; }
        #loginButton:hover { background-color: var(--primary-hover-color); border-color: var(--primary-hover-color); }
        .header-image { max-width: 250px; margin-bottom: 1rem; }
        .filter-search-wrapper { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .search-container { flex-grow: 1; display: flex; align-items: center; background-color: #f0f2f5; border-radius: 14px; padding: 0 1rem; margin-bottom: 0; }
        .select-filter-container { flex-shrink: 0; width: 280px; display: flex; align-items: center; background-color: #f0f2f5; border-radius: 14px; padding: 0 1rem; margin-bottom: 0; }
        .select-filter-container .fa-filter { color: #aaa; font-size: 1rem; margin-right: 0.75rem; }
        #categoryFilterSelect {
            width: 100%; padding: 12px 10px 12px 0; border: none; font-size: 1rem; background-color: transparent;
            outline: none; box-shadow: none; -webkit-appearance: none; -moz-appearance: none; appearance: none;
            cursor: pointer; background-image: url("data:image/svg+xml;charset=UTF8,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='%23aaa'%3E%3Cpath%20d='M7%2010l5%205%205-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 1.5em;
        }
        #searchInput { width: 100%; padding: 12px 10px; border: none; font-size: 1rem; background-color: transparent; outline: none; box-shadow: none; }
        .search-container .fa-search { color: #aaa; font-size: 1.1rem; margin-right: 0.75rem; }
        .player-wrapper { background-color: #f0f2f5; border-radius: 14px; padding: 0.5rem; }
        #audioPlayer { width: 100%; margin: 0; box-shadow: none; border-radius: 0; }
        #audioPlayer::-webkit-media-controls-panel { background-color: #f0f2f5; }
        #audio-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .audio-list-item {
            display: flex; align-items: center; padding: 20px; margin-bottom: 0; background-color: #ffffff;
            border: 2px solid transparent; border-radius: 18px; cursor: pointer; transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .audio-list-item:hover { transform: translateY(-5px); box-shadow: 0 10px 22px rgba(0,0,0,0.12); }
        .audio-list-item.active { border-color: var(--primary-color); background-color: #fff7f7; box-shadow: 0 0 0 4px rgba(211, 47, 47, 0.2); }
        .list-item-thumbnail { flex-shrink: 0; width: 100px; height: 100px; border-radius: 16px; overflow: hidden; margin-right: 20px; position: relative; background-color: #e9ecef; }
        .list-item-thumbnail img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .list-item-thumbnail img[src^="data:image/svg+xml"] { object-fit: contain; padding: 25%; box-sizing: border-box; opacity: 0.6; }
        .play-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.45);
            display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease;
        }
        .audio-list-item:hover .play-overlay, .audio-list-item.active .play-overlay { opacity: 1; }
        .play-overlay i { font-size: 2.8rem; color: #ffffff; transition: all 0.2s ease; }
        .audio-list-item:hover .play-overlay i { transform: scale(1.1); }
        .audio-list-item.active .play-overlay i { color: var(--primary-color); }
        .list-item-info { flex-grow: 1; min-width: 0; }
        .list-item-title {
            font-size: 1.1rem; font-weight: 500; color: var(--text-primary-color); line-height: 1.4; margin: 0;
            overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2;
        }
        .audio-list-item.active .list-item-title { font-weight: 700; color: var(--primary-color); }
        #loading-message { text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--text-secondary-color); width: 100%; }
        @media (max-width: 1200px) { #audio-list { grid-template-columns: repeat(2, 1fr); gap: 16px; } }
        @media (max-width: 768px) {
            body { padding: 0; align-items: flex-start; }
            .app-container { height: 100vh; border-radius: 0; max-width: 100%; }
            .player-header, #audio-list-container { padding: 1rem 1.5rem; }
            .card-title { font-size: 1.5rem; }
            .header-image { max-width: 200px; }
            .filter-search-wrapper { flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
            .select-filter-container { width: 100%; }
            #audio-list { grid-template-columns: 1fr; gap: 12px; }
            .audio-list-item { padding: 12px; }
            .list-item-thumbnail { width: 60px; height: 60px; margin-right: 16px; }
            .play-overlay i { font-size: 1.8rem; }
            .list-item-title { font-size: 1.05rem; }
        }
    </style>
</head>
<body>

<div id="login-container">
    <div class="login-card">
        <div class="text-center">
            <h3 class="card-title">ตรวจสอบสิทธิ์</h3>
            <p class="card-subtitle">กรุณากรอกรหัสพนักงานของคุณ</p>
        </div>
        <div class="form-group">
            <input type="text" class="form-control" id="employeeIdInput" placeholder="รหัสพนักงาน">
        </div>
        <button id="loginButton" class="btn btn-danger btn-block">ตรวจสอบสิทธิ์</button>
    </div>
</div>

<div class="app-container" id="player-container" style="display: none;">
    <div class="player-header">
        <div class="text-center">
            <img src="https://img5.pic.in.th/file/secure-sv1/-1920-x-300-px.png" alt="Company Logo" class="header-image" style="max-width: 350px; margin-bottom: 1.5rem;">
            <h3 class="card-title">รายการไฟล์เสียง</h3>
            <p class="card-subtitle">ค้นหาและเลือกไฟล์เสียงที่ต้องการฟัง</p>
        </div>
        
        <div class="filter-search-wrapper">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="ค้นหาชื่อไฟล์เสียง...">
            </div>
            
            <div class="select-filter-container">
                <i class="fas fa-filter"></i>
                <select id="categoryFilterSelect">
                    <option value="all">ตัวกรองทั้งหมด</option>
                    <option value="non"> NON</option>
                    <option value="pre-legal"> PRE-LEGAL</option>
                    <option value="l1"> L1</option>
                    <option value="l2"> L2</option>
                    <option value="l3"> L3</option>
                    <option value="l4"> L4</option>
                </select>
            </div>
        </div>

        <div class="player-wrapper">
            <audio id="audioPlayer" controls controlslist="nodownload"></audio>
        </div>
    </div>
    <div id="audio-list-container">
        <div id="audio-list"></div>
        <div id="loading-message" class="text-center w-100">
            <i class="fas fa-spinner fa-spin fa-2x"></i> 
            <p class="mt-2">กำลังโหลดรายการ...</p>
        </div>
        <div id="no-results-message" style="display: none; text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--text-secondary-color); width: 100%;">
            ไม่พบไฟล์ที่ตรงกับเงื่อนไข
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // URL ของ Google Apps Script (ไม่ต้องแก้ไข)
    const scriptURL = 'https://script.google.com/macros/s/AKfycby9v6IzoNdbNhfwXv4zaR3rNX0-NkP2rhoFvdO5D3VKUCDPcxwRTCCOkFlYF759POJF/exec';
    
    // การอ้างอิงถึง Element ต่างๆ ในหน้าเว็บ
    const loginContainer = document.getElementById('login-container');
    const playerContainer = document.getElementById('player-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const loginButton = document.getElementById('loginButton');
    
    const audioList = document.getElementById('audio-list');
    const audioPlayer = document.getElementById('audioPlayer');
    const loadingMessage = document.getElementById('loading-message');
    const noResultsMessage = document.getElementById('no-results-message'); // NEW: อ้างอิง div ใหม่
    const searchInput = document.getElementById('searchInput');
    const categoryFilterSelect = document.getElementById('categoryFilterSelect');
    
    let currentPlayingCard = null;
    let audioFiles = []; // Master list ของไฟล์เสียงทั้งหมด จะไม่ถูกแก้ไขหลังโหลดเสร็จ

    // --- ส่วนของการ Login (ไม่มีการแก้ไข) ---
    function handleLogin() {
        const employeeId = employeeIdInput.value.trim();
        if (!employeeId) {
            Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกรหัสพนักงาน', 'warning');
            return;
        }
        Swal.fire({
            title: 'กำลังตรวจสอบข้อมูล',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => { Swal.showLoading(); }
        });
        const formData = new FormData();
        formData.append('action', 'checkEmployeeId');
        formData.append('employeeId', employeeId);
        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.close();
                    loginContainer.style.display = 'none';
                    playerContainer.style.display = 'flex';
                    loadPlaylist(); // เรียกโหลดเพลงหลัง Login สำเร็จ
                } else {
                    throw new Error(data.error || 'รหัสพนักงานไม่ถูกต้อง');
                }
            })
            .catch(error => {
                Swal.fire('ตรวจสอบสิทธิ์ไม่สำเร็จ', error.message, 'error');
            });
    }
    loginButton.addEventListener('click', handleLogin);
    employeeIdInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            handleLogin();
        }
    });

    // --- ส่วนของการโหลดและสร้างรายการเพลง ---
    function loadPlaylist() {
        loadingMessage.style.display = 'block';
        audioList.style.display = 'none';
        const formData = new FormData();
        formData.append('action', 'getAudioFileList');
        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                loadingMessage.style.display = 'none';
                if (data.result === 'success' && data.files && data.files.length > 0) {
                    audioFiles = data.files;
                    // CHANGE: เรียกฟังก์ชันสร้างรายการเพลงแค่ครั้งเดียว
                    createInitialPlaylist(audioFiles); 
                    audioList.style.display = 'grid';
                } else {
                    audioList.innerHTML = '<p class="text-center text-muted p-3 w-100">ไม่พบไฟล์เสียงในโฟลเดอร์ที่กำหนด</p>';
                }
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถโหลดรายการไฟล์เสียงได้: ' + error.message, 'error');
            });
    }

    // NEW: ฟังก์ชันสำหรับสร้าง Element ของรายการเพลงทั้งหมดเพียง "ครั้งเดียว"
    function createInitialPlaylist(files) {
        audioList.innerHTML = ''; // ล้างรายการแค่ครั้งนี้ครั้งเดียว
        const defaultImageUrl = `data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3e%3cpath d='M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'/%3e%3c/svg%3e`;
        
        files.forEach((file, index) => {
            const fileName = file.name.replace(/\.[^/.]+$/, "");
            
            const listItem = document.createElement('div');
            listItem.className = 'audio-list-item';
            listItem.dataset.id = file.id;
            listItem.dataset.index = index; // เก็บ index ดั้งเดิมไว้
            
            const imageElementId = `thumb-${file.id}`;
            listItem.innerHTML = `
                <div class="list-item-thumbnail">
                    <img id="${imageElementId}" src="${defaultImageUrl}" alt="Thumbnail" loading="lazy">
                    <div class="play-overlay"><i class="fas fa-play"></i></div>
                </div>
                <div class="list-item-info">
                    <div class="list-item-title" title="${fileName}">${fileName}</div>
                </div>
            `;
            
            listItem.addEventListener('click', () => playTrack(listItem));
            audioList.appendChild(listItem);

            if (file.imageId) {
                fetchAndSetImage(file.imageId, imageElementId);
            }
        });
    }

    function fetchAndSetImage(imageId, imgElementId) {
        const imgElement = document.getElementById(imgElementId);
        if (!imgElement) return;

        const formData = new FormData();
        formData.append('action', 'getImageFileData');
        formData.append('id', imageId);

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success' && data.url) {
                    imgElement.src = data.url;
                }
            })
            .catch(error => { console.error('Error fetching image:', error); });
    }

    // --- ส่วนของการเล่นเพลงและฟังก์ชันการกรอง (แก้ไขใหม่) ---

    // **MAJOR CHANGE**: ฟังก์ชันนี้จะ "ซ่อน/แสดง" แทนการสร้างใหม่ทั้งหมด
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const activeFilter = categoryFilterSelect.value;
        
        const allItems = audioList.querySelectorAll('.audio-list-item');
        let visibleCount = 0;

        allItems.forEach(item => {
            const index = parseInt(item.dataset.index, 10);
            const file = audioFiles[index];
            const fileNameLower = file.name.toLowerCase();

            // ตรวจสอบเงื่อนไข 1: ตรงกับ Category ที่เลือกหรือไม่
            const categoryMatch = (activeFilter === 'all') || fileNameLower.includes(activeFilter);
            
            // ตรวจสอบเงื่อนไข 2: ตรงกับคำค้นหาหรือไม่
            const searchMatch = fileNameLower.includes(searchTerm);

            if (categoryMatch && searchMatch) {
                item.style.display = 'flex'; // แสดงรายการ
                visibleCount++;
            } else {
                item.style.display = 'none'; // ซ่อนรายการ
            }
        });

        // แสดงหรือซ่อนข้อความ "ไม่พบผลลัพธ์"
        noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
        audioList.style.display = visibleCount > 0 ? 'grid' : 'none';
    }

    // CHANGE: เปลี่ยน Event Listener ให้เรียกใช้ฟังก์ชันใหม่
    searchInput.addEventListener('input', applyFilters);
    categoryFilterSelect.addEventListener('change', applyFilters);

    function playTrack(cardElement) {
        if (!cardElement || cardElement.classList.contains('loading')) return;
        cardElement.classList.add('loading');
        Swal.fire({
            title: 'กำลังโหลดไฟล์เสียง',
            text: 'กรุณารอสักครู่...',
            allowOutsideClick: false, showConfirmButton: false,
            willOpen: () => { Swal.showLoading(); }
        });
        const formData = new FormData();
        formData.append('action', 'getAudioFileData');
        formData.append('id', cardElement.dataset.id);
        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.result === 'success') {
                    audioPlayer.src = data.url;
                    audioPlayer.play();
                    if (currentPlayingCard) currentPlayingCard.classList.remove('active');
                    cardElement.classList.add('active');
                    currentPlayingCard = cardElement;
                } else {
                    throw new Error(data.error || 'ไม่สามารถโหลดข้อมูลเสียงได้');
                }
            })
            .catch(error => { Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถเล่นไฟล์เสียงได้: ' + error.message, 'error'); })
            .finally(() => { cardElement.classList.remove('loading'); });
    }

    // **MAJOR CHANGE**: ปรับปรุง Logic การเล่นเพลงถัดไปให้ถูกต้องตาม Filter
    audioPlayer.addEventListener('ended', () => {
        if (!currentPlayingCard) return;

        // 1. ค้นหารายการทั้งหมดที่ "มองเห็น" อยู่ในปัจจุบัน
        const allVisibleItems = Array.from(audioList.querySelectorAll('.audio-list-item'))
                                     .filter(item => item.style.display !== 'none');
        
        // 2. หาว่าเพลงที่เล่นจบ อยู่ลำดับที่เท่าไหร่ในรายการที่มองเห็น
        const currentVisibleIndex = allVisibleItems.findIndex(item => item === currentPlayingCard);

        // 3. ถ้ายังมีเพลงถัดไปในรายการที่มองเห็น ให้เล่นเพลงนั้น
        if (currentVisibleIndex > -1 && currentVisibleIndex < allVisibleItems.length - 1) {
            const nextCardElement = allVisibleItems[currentVisibleIndex + 1];
            playTrack(nextCardElement);
        } else {
            // ถ้าเป็นเพลงสุดท้ายของรายการแล้ว ก็หยุด
            currentPlayingCard.classList.remove('active');
            currentPlayingCard = null;
        }
    });
</script>
</body>
</html>
